<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Typing Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      background: #f5f5f5;
      box-shadow: 0 0 10px #ccc;
    }
    #stage {
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 10px;
    }
    .timer {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
      text-align: right;
    }
    .progress-bar {
      height: 6px;
      margin-bottom: 18px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }
    .bar {
      height: 100%;
      width: 0;
      background: #3bce63;
      transition: width 0.2s;
      border-radius: 3px;
    }
    .text {
      font-size: 22px;
      margin-bottom: 16px;
      letter-spacing: 2px;
      min-height: 60px;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .correct {
      color: #32a852;
      background: #e7ffe1;
      border-radius: 2px;
    }
    .wrong {
      color: #ff3131;
      background: #ffe8e8;
      border-radius: 2px;
    }
    textarea {
      width: 100%;
      min-height: 60px;
      font-size: 20px;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      box-sizing: border-box;
      resize: none;
      background: #fafafa;
      font-family: monospace;
    }
    button {
      padding: 8px 18px;
      font-size: 16px;
      background: #32a852;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 6px;
    }
    button:hover {
      background: #2b9144;
    }
    #secretInput {
      font-size: 12px;
      padding: 5px 8px;
      width: 100%;
      margin-top: 12px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #secretPanel {
      display: none;
      border: 1px solid #888;
      background: #eee;
      padding: 12px 16px;
      margin-top: 12px;
      border-radius: 5px;
    }
    #secretPanel button {
      background: #0066CC;
      margin-top: 8px;
      width: 100%;
    }
    #secretPanel button:hover {
      background: #004C99;
    }
  </style>
</head>
<body>
  <div id="stage">Stage: 1</div>
  <div class="timer" id="timer">Time: 120</div>
  <div class="progress-bar"><div class="bar" id="bar"></div></div>
  <div class="text" id="text"></div>
  <textarea id="input" placeholder="Start typing here..." autofocus></textarea>
  <button onclick="restart()">Restart</button>
  <input id="secretInput" placeholder="Enter secret code here (small)" />
  <div id="secretPanel">
    <button id="autoType">AutoType</button>
    <button id="closeSecret" style="margin-top: 6px; background: #c33;">Close</button>
  </div>

<script>
  const stages = [
    "In the twilight of a serene evening, the sun dipped below the horizon painting the sky with hues of orange and crimson as gentle breezes whispered through the leaves.",
    "A vast expanse of ancient forests stretched endlessly, where the songs of myriad birds intertwined with the rustling trees creating a symphony of nature’s purest music.",
    "Through winding rivers and rugged mountains, the brave adventurers journeyed beyond the known realms seeking treasures hidden within enchanted caves guarded by mystical beasts.",
    "The whispered legends spoke of a radiant crystal that held the power to heal all wounds and bestow eternal wisdom, guarded fiercely by shadows lurking in forgotten ruins.",
    "As dawn broke over the sleepy village, golden rays illuminated cobblestone streets bustling with merchants, children’s laughter, and the scent of freshly baked bread wafting in the air.",
    "Beneath the vast star-studded canvas of night, the ancient temple stood tall, its intricate carvings telling tales of gods and heroes long faded into legend but never forgotten.",
    "The playwright penned an elaborate narrative filled with twists and revelations that challenged the audience’s perception of truth, reality, and illusion within the fleeting moments of performance.",
    "Hidden within dusty tomes and scrolls lay secrets of lost civilizations, their profound knowledge waiting patiently for the curious minds to decipher and unlock forgotten mysteries.",
    "Amid the chaotic storm, determined ships fought relentless waves, with every sailor grasping hope tightly as the beacon of the lighthouse promised safe passage through treacherous waters.",
    "In realms where magic intertwined with technology, towering cities shimmered with light and sound, while inhabitants explored the delicate balance between ancient wisdom and futuristic innovation."
  ];

  let currentStage = 0;
  let charEls = [];
  let timerInterval = null;
  let startTime = null;
  const timeLimit = 120; // seconds
  let gameEnded = false;
  let autoTyping = false;
  let autoTypeIndex = 0;
  let autoTypeInterval = null;

  const textEl = document.getElementById('text');
  const inputEl = document.getElementById('input');
  const stageEl = document.getElementById('stage');
  const timerEl = document.getElementById('timer');
  const barEl = document.getElementById('bar');
  const secretInput = document.getElementById('secretInput');
  const secretPanel = document.getElementById('secretPanel');
  const autoTypeBtn = document.getElementById('autoType');
  const closeSecretBtn = document.getElementById('closeSecret');

  function populateText(str) {
    textEl.innerHTML = '';
    charEls = [];
    str.split('').forEach(letter => {
      const span = document.createElement('span');
      span.innerText = letter;
      textEl.appendChild(span);
      charEls.push(span);
    });
  }

  function resetCharEls() {
    charEls.forEach(charEl => {
      charEl.classList.remove('correct');
      charEl.classList.remove('wrong');
    });
  }

  function startGame() {
    inputEl.value = '';
    gameEnded = false;
    autoTyping = false;
    if(autoTypeInterval){
      clearInterval(autoTypeInterval);
      autoTypeInterval = null;
    }
    if(currentStage >= stages.length) currentStage = 0;
    stageEl.innerText = 'Stage: ' + (currentStage + 1);
    populateText(stages[currentStage]);
    barEl.style.width = '0%';
    timerEl.innerText = 'Time: ' + timeLimit;
    if(timerInterval) clearInterval(timerInterval);
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 100);
  }

  function endGame(success) {
    gameEnded = true;
    if(autoTypeInterval){
      clearInterval(autoTypeInterval);
      autoTypeInterval = null;
    }
    clearInterval(timerInterval);
    setTimeout(() => {
      if(success){
        alert('Well Done! You finished stage ' + (currentStage + 1) + '.');
        currentStage++;
        startGame();
      } else {
        alert('Time\'s up! Try again.');
        startGame();
      }
    }, 100);
  }

  function updateTimer() {
    let elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerEl.innerText = 'Time: ' + (timeLimit - elapsed);
    if((timeLimit - elapsed) <= 0 && !gameEnded){
      endGame(false);
    }
  }

  function updateProgressBar(percent) {
    barEl.style.width = percent + '%';
  }

  inputEl.addEventListener('input', () => {
    if(gameEnded || autoTyping) return;
    const val = inputEl.value;
    resetCharEls();
    let errorCount = 0;
    let currentText = stages[currentStage];
    let minLen = Math.min(val.length, currentText.length);
    for(let i=0; i<minLen; i++){
      if(val[i] === currentText[i]){
        charEls[i].classList.add('correct');
      } else {
        charEls[i].classList.add('wrong');
        errorCount++;
      }
    }
    updateProgressBar((val.length / currentText.length) * 100);
    if(val.length === currentText.length && errorCount === 0){
      endGame(true);
    }
  });

  // Secret code input logic
  secretInput.addEventListener('keydown', e => {
    if(e.key === 'Enter'){
      if(secretInput.value.trim() === 'DEANISCOOLBEANSLOL'){
        secretPanel.style.display = 'block';
        secretInput.value = '';
        secretInput.blur();
      }
    }
  });

  autoTypeBtn.addEventListener('click', () => {
    if(autoTyping) return;
    autoTyping = true;
    inputEl.value = '';
    autoTypeIndex = 0;
    resetCharEls();

    autoTypeInterval = setInterval(() => {
      if(autoTypeIndex < stages[currentStage].length){
        inputEl.value += stages[currentStage][autoTypeIndex];
        inputEl.dispatchEvent(new Event('input'));
        autoTypeIndex++;
      } else {
        clearInterval(autoTypeInterval);
        autoTyping = false;
        endGame(true);
      }
    }, 20);
  });

  closeSecretBtn.addEventListener('click', () => {
    secretPanel.style.display = 'none';
    inputEl.focus();
  });

  function restart() {
    currentStage = 0;
    startGame();
    secretPanel.style.display = 'none';
  }

  window.onload = startGame;
</script>
</body>
</html>